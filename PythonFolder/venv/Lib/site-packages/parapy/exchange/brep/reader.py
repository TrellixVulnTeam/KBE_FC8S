#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2016-2021 ParaPy Holding B.V.
#
# This file is subject to the terms and conditions defined in
# the license agreement that you have received with this source code
#
# THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY
# KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR
# PURPOSE.

from OCC.utils.exchange.brep import shape_from_brep_file

from parapy.core import Attribute, FileReader
from parapy.geom.occ.brep import TopoDS_Shape2ParaPy


class BRepReader(FileReader):
    """Read shape from .brep file. Result is accessible from :attr:`shape`
    Attribute. Usage:

    >>> from parapy.exchange import BRepReader
    >>> reader = BRepReader(filename="path/to/your/file.brep")
    >>> reader.shape  # doctest: +ELLIPSIS
    Read: path/to/your/file.brep
    <Compound_ ...>
    """

    __initargs__ = ["filename"]
    file_or_dir = "file"
    wildcard = "BRep files (*.brep,*.BRep,*.BREP) |*.brep;*.BRep;*.BREP"

    @Attribute(in_tree=True)
    def shape(self):
        """Shape read from .brep file, returned as a (derived) instance of
        :class:`~parapy.geom.occ.brep.Brep`.

        :rtype: parapy.geom.BRep
        """
        filename = self.resolve_pathname(None)
        topods_shape = shape_from_brep_file(filename)
        print("Read:", filename)

        cls = TopoDS_Shape2ParaPy(topods_shape)
        return cls(TopoDS_Shape=topods_shape)

    def read(self, pathname=None):
        old_filename = self.filename
        # note that we cannot set filename, because we do not know if it is
        # settable in an inherited class
        new_filename = self.resolve_pathname(pathname)
        if new_filename == old_filename:
            print(f"Skipped re-reading file: {old_filename}")
        else:
            self.filename = new_filename
        try:
            return self.shape
        except Exception:
            # when it fails, restore the old filename
            self.filename = old_filename
            raise
